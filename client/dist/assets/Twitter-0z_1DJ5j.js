import{cj as f,y as h,u as g,M as l,a7 as i}from"./index-D7iYTMbv.js";const d=f("twitter",{state:()=>({is_logged_in_twitter:!1,selected_twitter_account:null,challenge_solvers:{}}),actions:{async update(){const s=h(),t=g();if(await s.fetchUser()!==null&&s.is_logged_in===!0&&s.user&&s.user.twitter_accounts.length>0){this.is_logged_in_twitter=!0,(t.settings.selected_twitter_account_id===null||!s.user.twitter_accounts.some(e=>e.id===t.settings.selected_twitter_account_id))&&(t.settings.selected_twitter_account_id=s.user.twitter_accounts[0].id);const a=s.user.twitter_accounts.findIndex(e=>e.id===t.settings.selected_twitter_account_id);this.selected_twitter_account=s.user.twitter_accounts[a]}},async initChallengeSolverIframe(s){if(this.challenge_solvers[s])return;const t=await _.fetchChallengeData(s);if(t===null){console.error(`[TwitterStore] Failed to fetch challenge data for @${s}.`);return}const r=document.createElement("iframe");r.style.display="none",r.src="/solver.html",document.body.appendChild(r),this.challenge_solvers[s]={solver_iframe:r,challenge_data:t},await new Promise(a=>{r.onload=a}),r.contentWindow.postMessage({action:"init",challenge:t.challenge_js_code,vendor:t.vendor_js_code,anims:t.challenge_animation_svg_codes,verificationCode:t.verification_code},"*"),await new Promise((a,e)=>{const n=o=>{if(o.source!==r.contentWindow)return;const c=o.data;c.action==="ready"?(window.removeEventListener("message",n),console.log(`[TwitterStore] Challenge Solver for @${s} initialized successfully.`),a()):c.action==="initError"&&(window.removeEventListener("message",n),console.error(`[TwitterStore] Challenge Solver for @${s} failed to initialize.`),l.error(`Twitter @${s} の Challenge Solver の初期化に失敗しました。`),a())};window.addEventListener("message",n)})},async solveChallenge(s,t){if(!this.challenge_solvers[s]&&(await this.initChallengeSolverIframe(s),!this.challenge_solvers[s]))return console.error(`[TwitterStore] Failed to initialize challenge solver for @${s}.`),null;const r=this.challenge_solvers[s];if(!r.challenge_data.endpoint_infos[t])return console.error(`[TwitterStore] Endpoint info for ${t} not found.`),null;const a=r.challenge_data.endpoint_infos[t],e=Date.now();return r.solver_iframe.contentWindow.postMessage({action:"solve",path:a.path,method:a.method,id:e},"*"),new Promise((n,o)=>{const c=w=>{if(w.source!==r.solver_iframe.contentWindow)return;const u=w.data;u.id===e&&(u.action==="solved"?(window.removeEventListener("message",c),console.log(`[TwitterStore] X-Client-Transaction-ID: ${u.result}`),n(u.result)):u.action==="error"&&(window.removeEventListener("message",c),console.error(`[TwitterStore] Challenge Solver for @${s} failed to solve challenge. (${u.error})`),l.error(`Twitter @${s} の Challenge Solver が Challenge を解決できませんでした。`),n(null)))};window.addEventListener("message",c)})}}});class _{static async fetchAuthorizationURL(){const t=await i.get("/twitter/auth");return t.type==="error"?(i.showGenericError(t,"Twitter アカウントとの連携用の認証 URL を取得できませんでした。"),null):t.data.authorization_url}static async auth(t){const r=await i.post("/twitter/auth",t);if(r.type==="error"){if(typeof r.data.detail=="string"){if(r.data.detail.startsWith("Failed to authenticate with password")){const a=r.data.detail.match(/Message: (.+)\)/)[1];return l.error(`ログインに失敗しました。${a}`),!1}else if(r.data.detail.startsWith("Unexpected error occurred while authenticate with password")){const a=r.data.detail.match(/Message: (.+)\)/)[1];return l.error(`ログインフローの途中で予期せぬエラーが発生しました。${a}`),!1}else if(r.data.detail.startsWith("Failed to get user information"))return l.error("Twitter アカウントのユーザー情報の取得に失敗しました。"),!1}return i.showGenericError(r,"Twitter アカウントとの連携に失敗しました。"),!1}return!0}static async logoutAccount(t){const r=await i.delete(`/twitter/accounts/${t}`);return r.type==="error"?(i.showGenericError(r,"Twitter アカウントとの連携を解除できませんでした。"),!1):!0}static async fetchChallengeData(t){const r=await i.get(`/twitter/accounts/${t}/challenge-data`);if(r.type==="error"){switch(r.data.detail){default:i.showGenericError(r,"Twitter の Challenge 情報を取得できませんでした。");break}return null}return r.data.is_success===!1?(l.error(r.data.detail),null):r.data}static async sendTweet(t,r,a){const e=new FormData;e.append("tweet",r);for(const c of a)e.append("images",c);const n=await d().solveChallenge(t,"CreateTweet"),o=await i.post(`/twitter/accounts/${t}/tweets`,e,{headers:{"Content-Type":"multipart/form-data","X-Client-Transaction-ID":n},timeout:10*60*1e3});return o.type==="error"?typeof o.data.detail=="string"?Number.isNaN(o.status)?{message:`ツイートの送信に失敗しました。(${o.data.detail})`,is_error:!0}:{message:`ツイートの送信に失敗しました。(HTTP Error ${o.status} / ${o.data.detail})`,is_error:!0}:{message:`ツイートの送信に失敗しました。(HTTP Error ${o.status})`,is_error:!0}:o.data.is_success===!1?{message:o.data.detail,is_error:!0}:{message:o.data.detail,is_error:!1}}static async retweet(t,r){const a=await d().solveChallenge(t,"CreateRetweet"),e=await i.put(`/twitter/accounts/${t}/tweets/${r}/retweet`,void 0,{headers:{"X-Client-Transaction-ID":a}});if(e.type==="error"){switch(e.data.detail){default:i.showGenericError(e,"ツイートをリツイートできませんでした。");break}return null}return e.data.is_success===!1?(l.error(e.data.detail),null):e.data}static async cancelRetweet(t,r){const a=await d().solveChallenge(t,"DeleteRetweet"),e=await i.delete(`/twitter/accounts/${t}/tweets/${r}/retweet`,{headers:{"X-Client-Transaction-ID":a}});if(e.type==="error"){switch(e.data.detail){default:i.showGenericError(e,"リツイートを取り消せませんでした。");break}return null}return e.data.is_success===!1?(l.error(e.data.detail),null):e.data}static async favorite(t,r){const a=await d().solveChallenge(t,"FavoriteTweet"),e=await i.put(`/twitter/accounts/${t}/tweets/${r}/favorite`,void 0,{headers:{"X-Client-Transaction-ID":a}});if(e.type==="error"){switch(e.data.detail){default:i.showGenericError(e,"ツイートをいいねできませんでした。");break}return null}return e.data.is_success===!1?(l.error(e.data.detail),null):e.data}static async cancelFavorite(t,r){const a=await d().solveChallenge(t,"UnfavoriteTweet"),e=await i.delete(`/twitter/accounts/${t}/tweets/${r}/favorite`,{headers:{"X-Client-Transaction-ID":a}});if(e.type==="error"){switch(e.data.detail){default:i.showGenericError(e,"いいねを取り消せませんでした。");break}return null}return e.data.is_success===!1?(l.error(e.data.detail),null):e.data}static async getHomeTimeline(t,r){const a=await d().solveChallenge(t,"HomeLatestTimeline"),e=await i.get(`/twitter/accounts/${t}/timeline`,{params:{cursor_id:r},headers:{"X-Client-Transaction-ID":a}});if(e.type==="error"){switch(e.data.detail){default:i.showGenericError(e,"ホームタイムラインを取得できませんでした。");break}return null}return"is_success"in e.data&&e.data.is_success===!1?(l.error(e.data.detail),null):e.data}static async searchTweets(t,r,a){const e=await d().solveChallenge(t,"SearchTimeline"),n=await i.get(`/twitter/accounts/${t}/search`,{params:{query:r,cursor_id:a},headers:{"X-Client-Transaction-ID":e}});if(n.type==="error"){switch(n.data.detail){default:i.showGenericError(n,"ツイートの検索に失敗しました。");break}return null}return"is_success"in n.data&&n.data.is_success===!1?(l.error(n.data.detail),null):n.data}}export{_ as T,d as u};
