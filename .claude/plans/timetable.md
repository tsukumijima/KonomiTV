# KonomiTV 番組表 (TimeTable) 機能 実装計画

## 概要

KonomiTV にテレビ番組表機能を追加する。PC・タブレット・スマホそれぞれの画面サイズに対応し、REGZA ブルーレイレコーダー風のデザインと EMWUI の優れた UX を組み合わせた番組表を実装する。

**URL**: `/timetable/`
**コンポーネント命名**: `TimeTable` プレフィックス（`Guide` や `Schedule` ではなく）

---

## ユーザーから一番最初に提示されたプロンプト（設計意図や要件が含まれる）

```
この KonomiTV に関して、フロントエンド・バックエンド両方を改修して、日本のテレビ番組表を表示できるようにして欲しいです（当然PC・タブレット・スマホそれぞれの画面で動作する必要があります）。
日本の番組表の UI というのは画像で示す通り結構複雑です。縦・横スクロールで操作できる必要がありますし、マウスドラッグやスマホのスワイプでもグリッと動かせる必要があります。また大量のDOMを必要とするので仮想スクロールが必要です。
そして EPGStation/ 以下には、あなたの実装参考用として EPGStation という別の日本のテレビ放送を管理するためのソフトウェアの Git リポジトリを clone してあります。（直接的な依存関係にはありません）
1枚目,2枚目は EPGStation の番組表です。この番組表は私のセンスとしてはお世辞にも見やすくて良い UI とは言えないと考えています。各番組をクリックするとダイヤログが出てきて番組詳細が表示されますが、私は後述の EMWUI のようにペイン方式の方が好みです。一方ですでに廃止された Vue 2.x かつ Class Component を使っているとはいえ、Vue でかなり高速な番組表の仮想スクロールが実装されている点において非常に参考になります（「モード：逐次」がデフォルトだったはず。非常にサクサクなのは便利）。ということで、番組表における仮想スクロールや表示周りの実装は原則 EPGStation の番組表周りのコードをベースに Vue 3 の setup 構文に移植する形で実装したいと考えています。基本的に EPGStation のコードはテスタビリティを考慮したのかかなり冗長に設計されており設計もかなりオーバースペックで、正直なところ私が個人で開発している以上なるべく冗長なところは削って比較的少ないファイル数に実装を収めたいところではあるんですが、ロジックの組み方や最大限参考にできるはずです。また、サーバー API の設計もある程度参考になるかもしれません。
なお、KonomiTV ではもっぱら番組表表示のために、EDCB や Mirakurun から取得した番組情報をだいぶ前から定期的に同期してDBにキャッシュする設計となっており、その際にデータ構造の変換などもすでに行っているので、当然このデータを活用する形で新規に番組表向け API を作ることになるでしょう。とはいえ一気にデータを返すと、番組情報は１週間で１５０００件以上に及んでいた記憶があり流石にデカすぎてアレなので、範囲指定とかで少しずつ読み取るとかするべことになるでしょうか。
次に EDCB_Material_WebUI/ 以下には、EDCB というこれまた別の日本のテレビ放送を管理するためのソフトウェアの Web UI 実装の Git リポジトリをあなたの実装参考用として clone してあります。（直接的な依存関係にはありません）
EDCB には Lua 5.2 と CivetWeb による Web サーバが組み込まれており, https://github.com/xtne6f/EDCB/blob/work-plus-s/Document/Readme_Mod.txt の通り独自のオレオレ API が存在します。この Web UI は、独自に HTML に Lua スクリプトを組み込んだり、API を Lua で組んだりする超トリッキーなコードと jQuery を駆使して作られた、多分作者の方以外は人間には解読不可能なほどお世辞にもクッソ汚いコードではあるのですが、一方番組表の体験は明らかにこちらの方が優れています。
3枚目,4枚目,5枚目は EDCB Material WebUI (EMWUI) の画面です。[字] [二] のような日本語特有の囲み文字へのハイライト（これはテレビホーム画面や番組情報画面など多くで ProgramUtils に実装したメソッドを使って実現していたはずです）も実装されていますし、５枚目のように録画中であることも明確です。また、クリックするたびにダイヤログが出てくるストレスフルな体験ではなく、番組をクリックすると詳細表示やクイック予約ボタンが出てきて、詳細表示ボタンを押すと右側からパネルが出てきて番組情報と録画設定、そして予約追加を行えるようになっています。番組によっては尺が短くタイトルや詳細のほとんどを表示できていない場合がありますが、こういう時にクリックするとフロートしたような効果が出て、後ろの番組を表示するために隠れていた部分が詳細まで含めて表示されて、例えばこの番組を詳細パネル開かずに単発予約するといったことが非常に簡単になっている素晴らしい体験です。現在時刻位置のライン線の UI もいい。
この EMWUI の詳細パネルは私自身参考にしており、KonomiTV では6枚目、7枚目の写真のように予約一覧機能を実装しているのですが（EPG予約、番組検索機能は未実装）、EMWUI のパネルの構成をより使いやすくスマホでも読みやすく、さらに視聴画面の Program.vue のデザインとも一貫性を保てるように現代的に私のセンスでリファインしたものとなっています。つまりこのコンポーネントをすでに実装しているので、それを最大限活用したいです。
上部のバーは、左から順に：
- 丸いボタンぽいのが現在の時刻に戻るボタン
  - （これはわかりづらいのでもっとわかりやすいUIにしたい）
- 地デジ・BS・CS などチャンネル種別ごとの番組表選択セレクトボックス
  - （EPGStation の番組表は地デジ・BS・CSで分かれていないのが、私はチャンネル数が多いことから流石に負荷的にも分けた方が良いと考える。その上で、地デジ・BS・CSより前に、KonomiTV独自の概念としてピン留め中チャンネルをホーム画面や視聴画面のチャンネルリストで表示できる我ながら神の機能を作っているので、「ピン留め」という項目をつけて、それがデフォルト表示されるようにすると良いでしょう。こうすれば地上波もBSも見るチャンネルだけの番組表が作りやすくなります。例えばMXとBS日テレ、BS11しか見ないアニメオタクにとっては、これらのチャンネルだけ追加しておけば好みの番組表を作れるということになりますし、体験としても一貫性が出ます。もちろん表示順序も尊重されるべきでしょう）
- 日付選択セレクトボックス
  - （単に日付が番組表データにある一番未来の日付まで選択できるだけでなく（そう考えるとその手の情報を取得する必要もありそうか）、左右ボタンを押すことで簡単に次の日付に移れること、また日付自体をカレンダーUIで直接入力できるのもテクくて結構体験が良いです）
  - （実は EDCB は過去の番組情報をストックできたりするし、ここでは過去の日付の番組表も表示できるんですが、利用機会が多くない上に流石にそれらを溜め込みすぎるとデータ量が膨大で仕方がないので、今のところ KonomiTV に取り込んだ番組表データは放送を過ぎたデータは順次 app/models/Program.py で削除されるようになっています。ただ将来的に過去日付を選択できるようにする余地は残しておきたい）
- 時間選択セレクトボックス
  -　（４時間ごとに選択できるので特定の時間に移動したい際、特にスマホなどで便利です。）
  - （ちなみに時刻表示は設定ですでに28時間表記にするかのフラグが存在するので、それがオンの時は24~27時表示とし、オフの時は0~23時表記にしてほしいところです）
となっており、機能的に非常に良く練られていること、また私自身がこれに慣れていることから、この上部バーの体験を基本的に継承したいと考えています。
ということで、上部の表示調整用フォームが付いたバーのデザインや体験設計は私自身６年以上愛用している EMWUI をベースにしたいと考えています。コードはお世辞にも汚いので参考になりませんが（SSRだったりSPAだったりゴチャゴチャだし…）、EPGStation ほどではないもののそれなりに軽量な番組表です。ただ仮想スクロールは実装できていないので番組表ロジックの基盤は EPGStation を強く参考にすべきでしょう。

そして現在の KonomiTV の画面を示したものが8、9, 10枚目です。
実装にあたっては、このトンマナに馴染むようにしつつでやりたいところ。なお番組表の中身（番組表示部分）は今のところ次に述べるように完全にダークにしない想定です。そして先ほど言及した上部バーに関しては、現状 KonomiTV では UI 上検索ボックスとアイコンにしか上部のヘッダーバーを使ってなくてもったいないので、PCにおいては検索ボックスの左側に EMWUI のヘッダーバーの下にある上部バーに表示してる UI 要素を統合するイメージで考えています。こうすれば番組表表示領域をより広く使えて良いと考えます。

そして最後に、番組表デザインの全体的なトンマナ（特に時刻表示部分の背景色やデザイン、番組セルの左側に指定したジャンルごとにハイライトが入り、かつ背景色もハイライトに応じて少し淡い色になるあたりとか）に関しては１１枚目の REGZA ブルーレイの番組表を強く参考にしたいと考えています。この UI が非常に見やすくて美しくて気に入っています（ただし、REGZAと異なり時刻表示を左右両方に出す必要はなく、スペース確保のため左だけ表示で問題ありません。なお時刻ごとにカラーリング代わりのがめっちゃ好きで、そこは色自体も強く再現していただきたい）。テレビ用のデザインなので余計な要素も多いですが、番組表部分に関しては見やすさがずば抜けている（特にハイライトを縦線で表現するあたり、全てのジャンルに色をつけずにある程度絞るあたりが情報量の整理として非常に秀逸）。ただし、上部のチャンネル UI に関しては１２枚目のレコーダーではなくテレビ本体のREGZAのUIのレイアウトを強く参考にしてください。ちなみにREGZAはBDレコーダーでもテレビ本体でも左右の時間表示を１時間ごとに徐々に色を変えることで他のレコーダーと比較しても大幅に美しい画面を実現している印象です。ただテレビ本体REGZAは番組セルの表示がちょっとイマイチなので、その辺りは基本的に１１枚目の方を参照していただきたい。

そして最後に要件です：
- （必須）PCならマウスドラッグでグリグリ上下左右に移動、ホイールでスクロール、チルトホイールで横スクロールが可能であること
- （必須）タッチデバイスならタッチでグリグリ上下左右に移動できること
- （必須）番組セルを PC ならクリック（設定でホバーした時に自動表示することもできるようにしたい）、スマホならタップで、他の時刻に隠れている部分も表示され、description の下に「番組詳細」「録画予約」の２つのボタンがあり（EMWUI と異なりこのボタンのテキストの左側にはアイコンを設置したい）、番組詳細をクリックするとすでに録画予約画面で実装しているドロワーパネルが開いて番組概要の確認や録画設定の変更、録画予約の追加・削除ができるようにすべき。すでにドロワーパネルは実装済みなのでそのコンポーネントを共通で使うこと。ただし予約追加ボタンはまだ当該コンポーネントには実装されていないはずなので適宜追加すること。このドロワーパネルは将来的に番組検索画面でも使う予定があります。
- （必須）EMWUI では番組表表示にかかわらず基本的にドロワーは折りたたまれているハンバーガーメニューとして実装されており、一方 EPGStation もそうですが表示状態に固定できるようになっています。KonomiTV ではその中間として、基本的に視聴画面以外では PC やタブレットでは左側のナビゲーションをどのページでも表示しているのですが、番組表ページのみ横幅を広く取るために、Watch.vue 関連コンポーネントの Navigation でテキストなしアイコンのみ（ツールチップあり）のホバーすると出てくるナビゲーションを実装しているのを参考にして、今の Navigation.vue にテキストを削除しボタンをアイコンのみを表示した正方形にして細長い縦長バーとして表示するオプションを追加した上で、番組表ページではそういう感じで表示してほしい。
- （必須）ProgramUtils に実装済みのものを使って、[字] [二] のような囲み文字を番組情報上でもハイライトして表示すべき
- （必須）EPGStation/client/ の実装を強く参考にして仮想スクロールを実装し、EPGStation の実装では1日分のみしか仮想スクロール範囲ができないが、だいたい現在時刻〜番組表の一番未来の情報（だいたい１週間後の情報が随時放送EPGで配信される）まで境目なくスクロールできること（もし技術的に極めて難易度が高いとかなら、一日の起点を4時とした上で1日あたりの番組表とし、次の日に行くには）。
- （必須）タブレットや、画面幅の小さいスマホでも表示できるようにすること。この時スマホでは１チャンネルごとの幅を狭くする形になる。
- （必須）マルチ編成という概念があり、一部時間のみ帯域を削って同じ TS ストリームで別の映像・音声を別のサービス ID (=BS/CSにおいてはチャンネル番号) で流すことで同じチャンネル番号で複数の放送を流すことができる。例えばNHKだとEテレの教育番組時間、野球中継などで野球やりながらニュースをやるために使われたりする。そして日本には TOKYO MX1 と TOKYO MX2, ケーブルテレビの自主放送（イッツコムch10, ch11 の中にそれぞれ２チャンネルある）、放送大学のように、同一 TS (つまり NID や TSID が同一) にもかかわらず２４時間常時放送されているサブチャンネルがあります。EMWUI ではこうしたチャンネルの場合、１チャンネル＝1TSごとに割り当てられた幅はそのまま、サービス ID ごとに分割して表示する。しかしこの場合、確かに一部の時間だけサブチャンネルをやる場合は合理的だが、1日８時間以上サブチャンネル放送をやっていてサブチャンネルでのマルチ編成放送が常態化しているチャンネルでは実質別チャンネルなのに画面が狭くなってしまう問題がある。ちなみに TOKYO MX1, MX2 の例で MX2 が 1/3 の幅になっているのは、TOKYO MX1 には 091, 092 の2チャンネルある（なぜか知らないが将来的に TOKYO MX1 の放送に紐づく形でサブチャンネルをやるため？092ch は 091 と映像・音声ストリームを共用しており番組表も全て 091 と共用なので存在しないも同然）中、MX2 が 093 として割り当てられているため、サブチャンネル領域を３等分した結果こうなっているものと思われる。
  - 一方 EPGStation では、番組情報が存在するサブチャンネルは常に別の列に表示される。しかし通常は BS141 でのみ放送だが、例えば１時間とか１番組だけ BS142 サブチャンネルが動く場合、その１時間のために余計な列が消費され、当然サブチャンネルは動いていない時はこの場合BS141と映像・音声・番組を完全に共有しているので番組情報が空白になる（あるいは重複する）のでスペース的に無駄が多い実装となっています。
  - そこで KonomiTV においては、「当該 TS のデフォルトサービス (一番番号が若いサービス) 以外のマルチチャンネルが、現在表示中の日付（ここは実装によるが、7日分仮想スクロールをやるなら7日間分見た方がいいかも、４時〜28時換算を１日とする）上において合計番組長８時間以上放送される（メインサービスと異なる番組情報が入っている）か」どうかでサブチャンネルの表示を分けたい。
    - 条件が false のとき、EMWUI のようにメインチャンネルの幅はそのまま、メインチャンネルとサブチャンネルの放送時間かぶっているセルのみ、EMWUI のように幅を分割して左側にメインチャンネル、右側にサブチャンネルの番組情報が表示されるようにする。このとき、例えばEテレには 021, 022, 023 とサブチャンネルがあり、このうち３チャンネル同時マルチ編成が行われることはほぼ100%なく基本的にメインチャンネルは当然 021 だがサブチャンネルとしては 023 が用いられる。この時 EMWUI のように単純に同一 TS に属するサービスをサービス数で割るとサブチャンネルとメインチャンネルの幅の比率が 2/3, 1/3 となってしまうので、ここでいう 022 (サブチャンネルとして登録されてはいるが少なくとも集計期間中にサブチャンネルとして使われてない)の存在は無視して、021 と 023 で、サブチャンネルが放送されている時間のみ幅を２等分する形がよりシンプルかつユーザーにとっても予測可能な動作になるのではと感じます。
      - このとき、分割されたセルをホバー or クリック・タップで開いた場合、その幅は分割された 1/2 サイズの幅ではなく、メインチャンネル分の幅にオーバーライドするような形で表示する必要があります（これはEMWUIの挙動と同じです）。当然展開を解けばメインチャンネルのも見れるようになるし、逆にメインチャンネルのを開いたらサブチャンネルのセルは強調表示されてる今の選択されたセルによって覆い隠されるイメージ。
    - 条件が true の時、例えば常時マルチ編成を行っている TOKYO MX2 チャンネルは TOKYO MX1 の隣に独自のチャンネル列を持って自動表示されるようになります。こうすることで別のチャンネルとして扱い、よりユーザーが認知しやすくなります。
      - なおこの時、例えば「特定の日にはマルチ編成を常時やっているが、特定の日には一切マルチ編成をしない」ような運用をしているチャンネルがあるかもしれません。ここは実装上悩ましいのですが、スクロール途中で日付切り替わったタイミングで動的に列が増減するのは多分かなり複雑になるしユーザーも戸惑うと思うので、「現在の日付から番組情報が今存在する一番未来の日付（だいたい７〜８日先）までの番組情報をそれぞれの日付の4時~28時で区切った上で、それぞれの時間範囲内の中で8時間以上されている日付が1つ以上あるサブチャンネル」であればこの条件を True とする形の方が良いかもしれません。SQLクエリが増えそうなので無理に ORM を使うよりゴリゴリ SQL 書いた方が高速化できそうな気はします。ちなみになぜ全体のうち８時間でないかというと「現在〜８日後までの間に1日１時間半だけサブチャンネル放送をやる」チャンネル（実際に存在します）が該当してしまうからです。あくまで１日の範囲内で８時間以上表示されているべき
    - この実装要件により、ある意味 EPGStation の仮想スクロールよりもはるかに実装が複雑になるかもしれないが、どのみち複雑さは避けられないコンポーネントなのでそこは許容範囲であまり妥協したくない。まずどこまで技術的に可能かというのがあるが・・・
- （必須）REGZA ブルーレイレコーダーの配色、また EMWUI の設定の設計を参考に、ジャンル大分類別にハイライトカラーを選べるようにしてください。これは当然クライアント設定として実装され、KonomiTV アカウントログイン時はサーバーへの同期対象である必要があります。
  - ハイライトカラーに関しては、正直色が多すぎてもなあという感じなので、自由にカラーピッカーとかで選べるようには当面せず、私の方で REGZA ブルーレイレコーダーの番組表のハイライト色をスポイトしたりそこの色相変えた版とかでハードコードして、ジャンルごとに白（デフォルト）・黄色・黄緑・青（水色に近いかも）・赤・オレンジ・黄土色・青緑のいずれかから選べる形を想定してます
  - 基本的にテレビの全ジャンルを見る人は少なく、だいたい私だったらアニメやニュース、他の人はバラエティやドラマなど一部のみ興味があり他の番組には興味がないことが多いと思うので、こうして色を割り当てた特定ジャンル以外のジャンルは白にしておくことで、番組表特有のギチギチ情報量の多さをかなり見やすくできると思う
  - 番組表設定は当然番組表を見ているときに調整やりたいと思うので、番組表画面においてPCでは検索ボックスの左側に設定アイコンを置き、そこをクリックすると番組表設定が「コメントのミュート設定」同様ダイヤログで開くようにします。とはいえ /settings/ 以下の設定にも動線がないとわかりづらいと思うので、そのダイヤログを設定の全般あたりからピン留め済みチャンネルダイヤログを開くあたりのとこの下に配置するとかが妥当だと考えます
  - EPG 番組情報がない領域、例えば放送休止中のところ、セルの穴とかは EMWUI 同様に灰色背景一色で表示されてほしい。これが背景色ってことになるかな？これに関する設定は不要。
  - (プロジェクトルート)/.claude/tmp_images/emwui_epgguide_settings.png に EMWUI の設定 UI のスクショを入れておきました。番組表設定系ダイヤログでは、EMWUI ほど設定項目は多くなくていいですが、以下の項目が必要です（UXライティングでどう一般ユーザー向けに表現すべきかが難しいので見出しや説明文とかは以下はあくまで機能を説明してるだけなので適切にリライトして欲しくて、どう説明するかは完全にあなたが最善を尽くして欲しくてお任せします）
    - チャンネルごとの列の幅（EMWUI とは異なり px 単位だとPCとスマホでのpxの整合性を保つのが大変なので、「広め」「通常」「細め」の3つから選べるような形とする。実際に参照される広め・通常・細めの幅に関してはPCやスマホなどデバイスの幅ごとに選定されるイメージ。デフォルトは通常とする。）
    - １時間ごとの行の高さ（？）（EMWUI とは異なり、上記同様の理由で「広め」「通常」「細め」の3つから選べるような形とする。実際に参照される広め・通常・細めの幅に関してはPCやスマホなどデバイスの幅ごとに選定されるイメージ。デフォルトは通常とする）。これを変更すると広めにすれば１時間ごとの表示がより詳細になるし、狭目にすると１時間ごとの表示がより圧縮される。
    - PC において、マウスをホバーした際に番組セルを全体表示するか
    - ジャンル別のハイライトカラー（ジャンル大分類ごとに上記で定義した、ハードコードされた色の中から選ぶ形。当然色のプレビューが出るべきなので v-select の中身表示を頑張る必要がありそう。ジャンルごとに色の重複は許可されており、例えばドラマとアニメ・特撮を同じ色にすることもできる）
    - この設定ダイヤログの実装は CommentMuteSettingsDialog の実装を最大限参考にして、デザイン自体も似たようなデザインである必要があります。
- （必須）当該番組が録画中である場合、点線の border で赤色（この赤色は secondary カラーかな）ハイライトし、またセルの左上にある分表示の直下にREGZA番組表のようにタイマーアイコンを success 色（つまりこのタイマーアイコンは予約可能か、一部のみか、ダメかを色で表すインジゲーターとする）で表示して、予約中であることを視覚的に表します。EMWUI では [録] という囲み文字を使っていますが、それより REGZA 番組表のようにアイコン表示した方が良いと思うので。逆に予約はしているが無効な時は、アイコンやボーダーに関しては同じで、色を赤色ではなく灰色とします。
  - これを実現するためには、各 Program 情報を返す際に EDCB バックエンドで当該番組が現在録画中であるか、録画ステータスがどうなってるかなどをを返す必要がありそうです（これはすでに実装されている予約一覧の API レスポンス構造が参考になるはず）。
  - 予約をしたがチューナー不足で一部分しか録画できない時は、EMWUI に合わせて、録画予約してる時同様にボーダーは点線で赤色ハイライトしつつ、タイマーアイコンは黄色に、その下に⚠️アイコンも表示し、背景色も通常の背景色をオーバーライトして黄色にして、ユーザーの注意を引くようにします（一部しか録画できない時点で意図せず録画失敗となる可能性があるため、チューナーが足りないなら優先度の調整が必要になる）。この時、詳細を開いてドロワーパネルを開いた時にも適切に「チューナー不足のために一部のみ録画される」旨の注意をドロワーパネル側に表示して、なんか色が違うけどどういうこと？と気づいたユーザーの疑問に応えられるように設計する必要があります。
  - 同様に予約をしたがチューナー不足で完全に録画不可能な場合は、同じく EMWUI に合わせて、一部のみ録画時と同様の表示（当然ドロワーにも表示を出す、ただし注意じゃなくてマジのエラーなのでエラー表示みたいな感じになる）を行います。この時タイマーアイコンはエラー色、その下に❌アイコンも表示するような形しましょう。当然セルの背景色も真っ赤にして、このままじゃ予約失敗しますよ！大丈夫ですか！というのを番組表を眺めたユーザーにわかりやすく伝える必要があるわけです。当然この実装をすれば、予約一覧で一部のみ録画ツールチップが出てる録画を開いた時のドロワーメニューでも詳細が出るので嬉しいということになるはず
  - EMWUI と違い、この辺りの色はハードコードでいきます。変更したい人ほぼいないだろうし。
- （必須）番組表の現在時刻バー（この色も secondary カラーとする）は現在時刻に合わせて動いていく必要があります。また現在時刻バーより上、放送が終了した番組に関しては EMWUI 同様グレーアウトさせるものとします（ただし１時間くらいはDBに残っているはずなので、グレーアウトしつつも disabled にはせず、録画予約は当然できないが番組詳細は見れるようにしといてください。）
- （必須）現在時刻バーが見えるうちに番組表をスクロール表示している場合、スクロール中を除き、現在時刻バーの位置はそのまま、時刻が経てば経つほどじわじわ番組表全体が下にスクロールされるように実装してください。DOM的にはたぶん現在時刻バーが下がった px 分だけ打ち消すように上にスクロールする形になるのかな？この辺りは EMWUI の実装がかなり参考になると思います (jQuery だけど・・・なんだかんだ結構作り込まれておりかなりすごいです)
- （必須）既存のコンポーネントの実装を参考にその実装パターンに合わせてください（特に UI デザイン）。ただし従来 Vue Options API で実装されている箇所がありますが、そこは Options API のまま、新規実装画面のみ Composition API で実装しているので、その方針は崩さないでください。
- （必須）時間表示部分の背景色に関して、上記の通り１時間ごとに徐々に色が変わっていく、だんだんと階調が美しい色で変化していくという REGZA の色をスポイトとか色相変化とかで完全に再現してほしいです。添付のスクショでは完全に色が映っていませんがなんとなく色合いから推定できると思います。夜は深みのある色、朝は緑とか青緑系統なのが結構視覚的イメージと一致していて良いUIだと思うんだよねえ・・・
- （必須）PC版前提で上記は書いていますが、スマホの UI としてどう上部バーとかを落とし込むかは完全にお任せします。なお KonomiTV のスマホ縦画面のみヘッダーバーがないのでそれ含めてどういう UI にするか考える必要があります。またレスポンシブ対応で極めて高度な実装となっていますので、「番組表に対応した結果他のページが壊れた」ということにならないように細心の注意を払う必要があります。テストは存在しないので・・・

なお、君のコンテキストが /compact された時のために、今回君に見てもらったのと同じ EPGStation と EMWUI と KonomiTV と REGZA の画像を (プロジェクトルート)/.claude/tmp_images/ 以下に入れておくので、読み直したくなったときに読んで上記設計意図通りにUIを実装できるよう頑張ってください。

ということでめちゃくちゃ詳細に私の頭の中にある設計を書き出したので、この意図通りに実装できるよう、まずは詳細な実装計画を立ててください。
今回の実装では、クライアント側番組表の実装要件に合わせてパフォーマンス上最適な設計として、サーバー API に関しても routers/ProgramsRouter.py に実装する必要がありますので、その詳細設計や仕様決めも併せてお願いします。
また実装にあたり分からない点、決定したい点、仕様が曖昧な点、私の判断を仰いだ方が良さそうな点などがあれば遠慮なく私に質問して欲しい（一度計画を走らせればだいたい意図通りになるくらいプランを詰めてから実装を開始したいので）。
ちなみに UI に関してはだいたい上記の方針の通りで、細かい体験に関してはあなたが考える最良のベストプラクティスで実装していただければ問題なく、上記方針が守られていれば細かい UI に関するお伺いは不要です。
```

---

## 先人の知見と反省

### EPGStation から学ぶこと

#### 採用すべき良い設計
1. **段階的 DOM 追加による UI フリーズ防止**
   - 500要素ごとに `await sleep(1)` でブラウザに処理時間を譲る
   - 数千の番組要素を一度に追加する際の UI フリーズを回避

2. **表示範囲キャッシュ（displayRange）**
   - スクロールイベント発火時に表示範囲を一度キャッシュ
   - `updateVisible()` ループ内での再計算を回避しパフォーマンス向上

3. **予約情報の O(1) ルックアップ**
   - `programId` をキーとした辞書型の `reserveIndex` で高速検索
   - 大量番組から予約状態を参照する際に線形探索を回避

4. **throttle と debounce の使い分け**
   - スクロール: `throttle(10ms)` で高頻度イベントを制御
   - リサイズ: `debounce(100ms)` で最終値確定を待つ

5. **iOS オーバースクロール対応**
   - スクロール値がマイナスや範囲外の場合は描画更新をスキップ
   - 画面のチラつき防止

#### 避けるべき悪い設計
1. **直接 DOM 操作の過度な使用**
   - `document.createElement()` で DOM を直接構築
   - Vue のリアクティビティ機構を活用すべき
   - **対策**: Vue 3 の Composition API と `h()` 関数を活用

2. **全要素の事前生成によるメモリ増加**
   - 全番組要素をメモリ上に保有
   - 長期間や大量チャンネルでメモリ使用量が急増
   - **対策**: 1日分に限定し、メモリ使用量を管理可能な範囲に

3. **onclick インラインハンドラの多用**
   - 各要素に異なる onclick を設定し、クロージャによるメモリオーバーヘッド
   - **対策**: イベントデリゲーション（親要素での一括ハンドリング）を採用

4. **TypeScript の any 型多用**
   - 型安全性の低下
   - **対策**: 厳密な型定義を徹底

### EMWUI から学ぶこと

#### 採用すべき良い設計
1. **モーメンタムスクロールの実装**
   - フリクション係数 `0.95`（毎フレーム 5% 減速）
   - `requestAnimationFrame` で 60fps 制御
   - 停止閾値 `1px` で CPU 負荷低減
   - `performance.now()` で高精度な時刻測定

2. **Pointer Events API の統一的な活用**
   - mouse/touch/pen を統一的に扱える
   - `movementX/Y` で相対移動量を正確に取得
   - `setPointerCapture()` でドラッグ中の確実なイベント捕捉

3. **200ms 遅延クリック検出**
   - ドラッグとクリックを確実に区別
   - ダブルクリック検出も可能
   - タイマーキャンセルでドラッグ時の誤クリック防止

4. **Material Design Easing**
   - `cubic-bezier(0.4, 0, 0.2, 1)` でスムーズなトランジション
   - ユーザー体験に最適化された加速/減速

5. **CSS Sticky + Intersection Observer の併用**
   - モダンブラウザ: CSS Sticky でパフォーマンス優先
   - 長い番組: Intersection Observer で番組名固定表示

6. **Private フィールドによるカプセル化**
   - `#` シンタックスで状態をカプセル化
   - グローバル変数汚染を防止

#### 避けるべき悪い設計
1. **jQuery への依存**
   - レガシーライブラリでバンドルサイズ増加
   - **対策**: Vanilla JS または Vue の機能を使用

2. **ハードコード化された値**
   - 200ms、0.95 などの魔法の数字
   - **対策**: 定数として定義し、必要に応じて設定可能に

3. **クリーンアップ処理の不足**
   - `observer.disconnect()` が呼ばれていない
   - SPA でメモリリークの原因に
   - **対策**: `onUnmounted()` で必ずクリーンアップ

4. **スクロール時の頻繁な DOM 再計算**
   - 毎フレーム `getBoundingClientRect()` を複数回呼び出し
   - **対策**: 値のキャッシュとバッチ処理

---

## 実装方針

### スクロール方式
- EPGStation の方式（全DOM事前生成 + CSS hidden切り替え）をベースに実装
- EMWUI の優れた UX 要素を取り入れる：
  - **モーメンタムスクロール**: Pointer Events API + フリクション係数(0.95)で自然な慣性スクロール
  - **スティッキーポジショニング**: 時間軸・チャンネルヘッダーは `position: sticky` で実装（JS不要、GPU加速）
  - **200ms遅延クリック**: ドラッグ誤クリック防止、ダブルクリックで詳細表示
  - **Intersection Observer**: 長い番組の番組名固定表示に活用
- 1日分（4:00〜翌4:00）の番組表を表示
- **日付遷移**: 一番下までスクロールしたら「次の日を見る」フロートボタンを画面下部中央に表示し、クリックで次の日に切り替え
- 一番上までスクロールしたら「前の日を見る」フロートボタンも同様に表示

### データ取得戦略（2段階取得）
1. **初期表示の高速化**: 初期表示に必要な範囲（現在時刻の少し前〜ビュー下端）の番組を先に取得して即座に表示
   - 初期表示では現在時刻バーがビューポート上部から15〜20%の位置に配置されるため、過去の番組も一部含める
   - 時間範囲は画面サイズから動的に計算（例: ビューポート高さから必要な時間幅を逆算）
2. **全データ取得**: その後すぐに1日分の全データを一括取得し、DOM・内部状態に反映
3. スクロール時には既に全データが読み込み済みのため、待ち時間は発生しない

---

## Phase 1 実装計画

### 1. サーバー側実装

#### 1.1 新規API: 番組表データ取得
**ファイル**: `server/app/routers/ProgramsRouter.py`

```
GET /api/programs/timetable
```

**パラメータ**:
- `start_time`: 開始日時（ISO8601形式、省略時は現在時刻）
- `end_time`: 終了日時（ISO8601形式、省略時はDBに存在する最終日時まで）
- `channel_type`: チャンネル種別（GR/BS/CS/CATV/SKY/BS4K、省略時は全て）
- `channel_ids`: チャンネルIDリスト（ピン留めチャンネル用、カンマ区切り）

**2段階取得の流れ**:
1. クライアントは `start_time` と `end_time` で現在時刻〜ビュー下端の範囲を指定して取得
2. レスポンス受信後、即座に `start_time` と `end_time` で1日分（4:00〜翌4:00）を指定して取得
3. 2回目のレスポンスで内部状態とDOMを更新（差分マージ）

**レスポンス形式**（チャンネルグループ形式）:
```json
{
  "channels": [
    {
      "channel": { "id": "NID32736-SID1024", "name": "NHK総合", ... },
      "programs": [
        {
          "id": "NID32736-SID1024-EID12345",
          "title": "ニュース",
          "description": "...",
          "start_time": "2025-01-01T19:00:00+09:00",
          "end_time": "2025-01-01T19:30:00+09:00",
          "duration": 1800,
          "genres": [{"major": "ニュース/報道", "middle": "定時・総合"}],
          "reservation": {  // EDCB連携時かつ予約がある場合のみ
            "id": 123,
            "status": "Reserved",  // "Reserved" | "Recording" | "Disabled"
            "recording_availability": "Full"  // "Full" | "Partial" | "Unavailable"
          } | null
        },
        ...
      ]
    },
    ...
  ],
  "date_range": {
    "earliest": "2025-01-01T04:00:00+09:00",
    "latest": "2025-01-08T04:00:00+09:00"
  }
}
```

**実装ポイント**:
- 既存の `ChannelsRouter.py` のSQL直接実行パターンを参考に高速化
- 予約情報は EDCB バックエンド時かつ当該番組に予約がある場合のみ `reservation` オブジェクトを設定
- `date_range` で番組表データの有効範囲を返す（日付セレクター用）
- パラメータ省略時はDBに存在する全番組を返す（Programsテーブルは7〜8日分に保たれている）

#### 1.2 マルチ編成判定ロジック
**ファイル**: `server/app/routers/ProgramsRouter.py`

「8時間ルール」の実装:
- 同一TS（network_id, transport_stream_id が同じ）内のサブチャンネルが、指定期間内のいずれかの日で8時間以上放送されているかを判定
- True の場合: サブチャンネルを独立した列として返す
- False の場合: メインチャンネルの `subchannel_programs` フィールドにサブチャンネル番組を含める

**注**: 3チャンネル同時のマルチ編成は帯域的に2チャンネルが限界でほぼ存在しないため、最初の実装ではメイン+サブ1チャンネルのみを想定。3チャンネル以上の同時放送は将来対応とする。

```python
# 判定SQL例（概念）
SELECT
    channel_id,
    SUM(duration) as total_duration
FROM programs
WHERE
    network_id = :nid AND transport_stream_id = :tsid
    AND service_id != :main_sid  -- メインサービス以外
    AND start_time >= :day_start AND end_time <= :day_end
GROUP BY channel_id, DATE(start_time, '+5 hours')  -- 4時起点で日付グループ化
HAVING total_duration >= 28800  -- 8時間 = 28800秒
```

#### 1.3 Pydanticスキーマ追加
**ファイル**: `server/app/schemas.py`

```python

class TimeTable(BaseModel):
    channels: list[TimeTableChannel]
    date_range: dict[str, datetime]  # earliest, latest

class TimeTableChannel(BaseModel):
    channel: Channel
    programs: list[TimeTableProgram]
    subchannel_programs: dict[str, list[TimeTableProgram]] | None = None  # service_id -> programs

class TimeTableProgram(Program):
    reservation: TimeTableProgramReservation | None = None

class TimeTableProgramReservation(BaseModel):
    id: int
    status: Literal['Reserved', 'Recording', 'Disabled']
    recording_availability: Literal['Full', 'Partial', 'Unavailable']
```

---

### 2. クライアント側実装

#### 2.1 ファイル構成

```
client/src/
├── views/
│   └── TimeTable.vue                    # 番組表メインページ
├── components/
│   └── TimeTable/
│       ├── TimeTableGrid.vue            # 番組表グリッド本体
│       ├── TimeTableChannelHeader.vue   # チャンネルヘッダー（上部 sticky）
│       ├── TimeTableTimeScale.vue       # 時刻スケール（左側 sticky）
│       ├── TimeTableProgramCell.vue     # 番組セル
│       ├── TimeTableCurrentTimeLine.vue # 現在時刻バー
│       └── TimeTableSettingsDialog.vue  # 番組表設定ダイアログ
├── stores/
│   └── TimeTableStore.ts                # 番組表状態管理
└── utils/
    └── TimeTableUtils.ts                # 番組表用ユーティリティ
```

#### 2.2 チャンネルヘッダー
**ファイル**: `client/src/components/TimeTable/TimeTableChannelHeader.vue`

**機能**:
- 各チャンネルのロゴ・チャンネル番号・チャンネル名を表示
- `position: sticky; top: 0;` で上部に固定
- **クリック時**: 該当チャンネルの視聴画面 (`/tv/:display_channel_id`) に遷移
- **ホバー時（PC）**: `cursor: pointer` + 背景色をわずかに明るくして clickable であることを示す

#### 2.3 番組表メインページ
**ファイル**: `client/src/views/TimeTable.vue`

**レイアウト構成**:
```
┌─────────────────────────────────────────────────────────────┐
│ HeaderBar（PC）/ SPHeaderBar（スマホ）                        │
│ ├─ [設定アイコン] [チャンネル種別] [日付] [時間] [検索]      │
├──┬──────────────────────────────────────────────────────────┤
│N │ TimeTableChannelHeader（チャンネルロゴ・名前、sticky）    │
│a ├──────────────────────────────────────────────────────────┤
│v │                                                          │
│i │ TimeTableTimeScale │ TimeTableGrid                       │
│g │   (時刻表示/sticky)│   (番組セル群 + 現在時刻バー)       │
│a │                    │                                      │
│t │                    │                                      │
│i │                    │                                      │
│o │                    │                                      │
│n │                    │                                      │
└──┴──────────────────────────────────────────────────────────┘
```

**PC版ヘッダーバー要素（検索ボックス左側に配置）**:
- 設定アイコン（番組表設定ダイアログを開く）
- チャンネル種別セレクター（ピン留め/地デジ/BS/CS）
  - **ピン留め**: 既存の `SettingsStore.settings.pinned_channel_ids` と `ChannelsStore.channels_list_with_pinned` を活用
  - ピン留めチャンネルの追加/削除/並び替えは TV ホーム画面と `PinnedChannelSettings.vue` で行う（番組表では参照のみ）
- 日付セレクター（左右ボタン + カレンダー）
- 時間セレクター（4時間ごと: 4時/8時/12時/16時/20時/24時）
- 「現在時刻に戻る」ボタン

**スマホ版**:
- 上部に専用のコントロールバーを配置
- SPHeaderBarの下に、チャンネル種別/日付/時間のコンパクトなセレクター

#### 2.4 番組表グリッド
**ファイル**: `client/src/components/TimeTable/TimeTableGrid.vue`

**実装方針**（EPGStation + EMWUI のハイブリッド）:
1. 全番組のDOM要素を事前生成し配列に保管（EPGStation方式）
2. `scroll` イベントで表示範囲を計算
3. 範囲外の要素は `.hidden` クラスで非表示化
4. throttle（10ms）でスクロールコールバックを間引き

**EMWUI から取り入れる実装**:
- **モーメンタムスクロール**: Pointer Events API + フリクション係数(0.95) + requestAnimationFrame
- **スティッキーポジショニング**: チャンネルヘッダー（`top: 0`）と時刻スケール（`left: 0`）は CSS の `position: sticky` で実装（JS不要）

**日付遷移フロートボタン**:
- スクロール位置が下端に近づいたら「次の日を見る ▼」ボタンを画面下部中央にフェードイン
- スクロール位置が上端に近づいたら「前の日を見る ▲」ボタンを画面上部中央にフェードイン
- クリック時は日付を切り替え、スクロール位置を適切な位置（次の日なら4:00、前の日なら27:59付近）にリセット
- ボタンは `position: fixed` で番組表グリッドの上に表示

**スクロール操作**:
- マウスドラッグ: Pointer Events API（`pointerdown` → `pointermove` → `pointerup`）で実装
- モーメンタムスクロール: `pointerup` 時に慣性スクロール開始（フリクション係数 0.95）
- ホイール: 縦スクロール（デフォルト）
- チルトホイール: 横スクロール（`deltaX` を使用）
- タッチ: 同じく Pointer Events API で統一処理

**スクロール同期**:
- CSS `position: sticky` を使用するため、JS での同期は不要

#### 2.5 番組セル
**ファイル**: `client/src/components/TimeTable/TimeTableProgramCell.vue`

**デザイン（REGZA風）**:
- 左側にジャンルハイライト縦線（3〜4px幅）
- 背景色はハイライト色の淡い版
- 左上に開始分表示（例: `00`, `30`）
- タイトル、説明文を表示
- `[字]` `[新]` 等の囲み文字は `ProgramUtils.decorateProgramInfo()` でハイライト

**予約状態表示**:
- 予約中: 点線ボーダー（secondary色）、タイマーアイコン（success色）
- 一部録画: 黄色背景、タイマーアイコン（warning色）+ ⚠️アイコン
- 録画不可: 赤背景、タイマーアイコン（error色）+ ❌アイコン
- 無効: 灰色ボーダー、タイマーアイコン（gray色）

**クリック/タップ時**:
- セルが展開され、隠れていた部分（description含む）が表示
- 「番組詳細」「録画予約」ボタンを表示（左側にアイコン付き）
- 「番組詳細」クリックで `ReservationDetailDrawer` を開く（予約有無に関わらず番組情報を表示できるよう拡張）
- 「録画予約」クリックで即座に録画予約を追加（クイック予約、EDCBデフォルトプリセットを使用）

**過去番組（終了済み）の場合**:
- セル自体はグレーアウト表示だがクリック可能
- 展開時は「番組詳細」ボタンのみ表示（「録画予約」ボタンは非表示）
- ドロワーでは番組情報の閲覧のみ可能（予約関連UIは非表示）

**Mirakurunバックエンド時**:
- 「録画予約」ボタンはグレーアウト＆disabled
- ドロワー内の予約関連UIもグレーアウト
- 「EDCBバックエンドが必要です」の notice を表示（サイレント非表示は避ける）

**ホバー時（PC、設定で有効化可能）**:
- クリックと同様にセルを展開表示

**マルチ編成表示（8時間未満のサブチャンネル）**:
- メインチャンネルとサブチャンネルの放送時間が重なる部分のみ、幅を2等分
- 展開時はメインチャンネル幅にオーバーレイ

#### 2.6 時刻スケール
**ファイル**: `client/src/components/TimeTable/TimeTableTimeScale.vue`

**REGZA風の色グラデーション**（時刻ごとに背景色を変化、REGZA画像から推定）:
```scss
// 4時〜翌4時までの24色（REGZA画像から色を推定）
$time-colors: (
  // 早朝（深い緑〜緑系）
  4: #1a4d3a,   // 深い緑
  5: #2d5a4a,   // 緑
  6: #3d6a5a,   // 明るい緑
  7: #4d7a6a,   // 青緑寄り

  // 午前（青緑〜水色系）
  8: #3d6a7a,   // 青緑
  9: #4d7a8a,   // 水色寄り
  10: #5d8a9a,  // 水色
  11: #6d9aaa,  // 明るい水色

  // 昼（水色〜薄い青紫系）
  12: #7daaba,  // 薄い青
  13: #8db0c0,  // 淡い青
  14: #9db0c8,  // 淡い青紫
  15: #a8b0d0,  // 薄い紫寄り

  // 夕方（紫〜ピンク紫系）
  16: #9a8ab0,  // 紫
  17: #a07aa8,  // 赤紫寄り
  18: #a86a9a,  // ピンク紫
  19: #b05a8a,  // 赤紫

  // 夜（赤紫〜深紫系）
  20: #8a4a7a,  // 深い赤紫
  21: #7a4a6a,  // 深紫寄り
  22: #6a4a5a,  // 暗い紫
  23: #5a4a5a,  // より暗い紫

  // 深夜（濃い紫〜藍色系）
  24: #4a4a6a,  // 深紫
  25: #3a4a5a,  // 藍紫
  26: #2a4a4a,  // 藍色
  27: #1a4a3a,  // 深い藍緑（4時に繋がる）
);
```

**レイアウト**（REGZA参考）:
- 時刻は2桁数字で大きく表示（例: `06`, `12`, `18`）
- 数字の下に小さく「時」を表示
- 背景色は上記の通り時刻ごとに変化

**表示形式**:
- **既存設定 `use_28hour_clock` を活用**（`SettingsStore.settings.use_28hour_clock`）
- オン時: 24時, 25時, 26時, 27時 と表示
- オフ時: 0時, 1時, 2時, 3時 と表示
- 番組時刻表示には `Utils.apply28HourClock()` を活用

#### 2.7 現在時刻バー
**ファイル**: `client/src/components/TimeTable/TimeTableCurrentTimeLine.vue`

- 赤い横線（2px、secondary色）
- 60秒ごとに位置を更新
- 現在時刻より上の番組（終了済み）はグレーアウト表示

**初期表示位置**（EMWUI スタイル）:
- 番組表を開いた時点で、現在時刻バーがビューポート上部から少し離れた位置（上端から約15〜20%の位置）に表示される
- これにより、過去の番組（グレーアウト表示）が一定程度見えた状態で開始される
- ユーザーは過去方向にもスクロール可能

**過去方向スクロール制限**:
- DB上に存在する最古の番組（通常は当日4:00以降）までスクロール可能
- 最古の番組より過去へはスクロールできない（上端で打ち止め）
- APIレスポンスの `date_range.earliest` を参照してスクロール上限を動的に設定

**自動追従スクロールのロジック**:
- **初期状態**: 番組表を開いた時点では自動追従が有効
- **追従解除条件**: ユーザーのスクロール操作により現在時刻バーがビューポートから見切れた場合、自動追従を解除
- **追従再開条件**: 現在時刻バーが再びビューポート内に表示されている状態で、毎分00秒のタイミングで自動追従を再開
- **更新頻度**: 自動追従時は毎分00秒に1回のみスクロールを実行（頻繁な自動スクロールはユーザー操作の邪魔になるため）
- **「現在時刻に戻る」ボタン**: クリックで即座に現在時刻バー位置にスクロールし、自動追従を再開

#### 2.8 番組表設定ダイアログ
**ファイル**: `client/src/components/TimeTable/TimeTableSettingsDialog.vue`

**設定項目**:
1. **チャンネル列の幅**: 広め/通常/細め（3択）
2. **1時間ごとの高さ**: 広め/通常/細め（3択）
3. **ホバー時に番組を展開**: オン/オフ（PCのみ）
4. **ジャンル別のハイライト色**:
   - ジャンル大分類ごとに色を選択
   - 選択肢: 白（デフォルト）/黄色/黄緑/青/赤/オレンジ/黄土色/青緑

**注**: 28時間表記は既存設定 `use_28hour_clock`（設定 > 全般）を使用するため、このダイアログには含めない

**実装参考**: `CommentMuteSettingsDialog.vue`

#### 2.9 Navigation.vue の拡張
**ファイル**: `client/src/components/Navigation.vue`

**アイコンのみモードの追加**:
- props に `iconOnly: boolean` を追加
- `iconOnly` が true の場合:
  - 幅を68pxに縮小
  - テキストを非表示
  - 各項目を正方形のアイコンボタンに
  - ホバー時にツールチップで項目名を表示

**番組表ページでの適用**:
- `TimeTable.vue` で `<Navigation :icon-only="true" />` として使用

#### 2.10 状態管理
**ファイル**: `client/src/stores/TimeTableStore.ts`

```typescript
interface ITimeTableState {
  // 表示設定
  selectedChannelType: 'Pinned' | 'GR' | 'BS' | 'CS';
  selectedDate: Date;
  scrollPosition: { x: number; y: number };

  // データ
  channelsData: ITimeTableChannel[];
  dateRange: { earliest: Date; latest: Date };

  // UI状態
  selectedProgramId: string | null;
  isLoading: boolean;
}
```

#### 2.11 クライアント設定の追加
**ファイル**: `client/src/stores/SettingsStore.ts`

```typescript
// ILocalClientSettings に追加
timetable_channel_width: 'Wide' | 'Normal' | 'Narrow';
timetable_hour_height: 'Wide' | 'Normal' | 'Narrow';
timetable_hover_expand: boolean;
timetable_genre_colors: {
  [genre: string]: 'White' | 'Yellow' | 'Lime' | 'Blue' | 'Pink' | 'Red' | 'Orange' | 'Brown' | 'Teal';
};
// 注: 28時間表記は既存の use_28hour_clock を使用
```

**同期対象に追加**: `SYNCABLE_SETTINGS_KEYS` に上記キーを追加

---

### 3. ルーティング設定

**ファイル**: `client/src/router/index.ts`

```typescript
{
  path: '/timetable',
  name: 'TimeTable',
  component: () => import('@/views/TimeTable.vue'),
  meta: { title: '番組表' }
}
```

---

### 4. デザイン詳細

#### 4.1 カラーパレット

**番組セル背景色**（ジャンルハイライト時）:
- 白: `#ffffff`（ハイライト）/ `#f8f8f8`（背景）
- 黄色: `#ffeb3b`（ハイライト）/ `#fffde7`（背景）
- 黄緑: `#8bc34a`（ハイライト）/ `#f1f8e9`（背景）
- 青: `#03a9f4`（ハイライト）/ `#e1f5fe`（背景）
- ピンク: (ちゃんと設定すべき)
- 赤: `#f44336`（ハイライト）/ `#ffebee`（背景）
- オレンジ: `#ff9800`（ハイライト）/ `#fff3e0`（背景）
- 黄土色: `#795548`（ハイライト）/ `#efebe9`（背景）
- 青緑: `#009688`（ハイライト）/ `#e0f2f1`（背景）

**番組がない領域**: `#9e9e9e`（灰色）

**予約状態色**:
- 予約中ボーダー: `var(--v-theme-secondary)`
- 一部録画背景: `#fff3cd`
- 録画不可背景: `#f8d7da`

#### 4.2 レスポンシブ対応

**PC（>=1280px）**:
- チャンネル列幅: 広め 180px / 通常 150px / 細め 120px
- 1時間高さ: 広め 240px / 通常 180px / 細め 120px
- Navigation: アイコンのみモード（68px幅）

**タブレット（600px〜1280px）**:
- チャンネル列幅: 広め 150px / 通常 120px / 細め 100px
- 1時間高さ: 広め 200px / 通常 150px / 細め 100px
- Navigation: アイコンのみモード

**スマホ（<600px）**:
- チャンネル列幅: 広め 120px / 通常 100px / 細め 80px
- 1時間高さ: 広め 160px / 通常 120px / 細め 80px
- Navigation: BottomNavigation
- 上部コントロールバー: コンパクト版

---

### 5. 実装順序

1. **サーバー側API**
   - Pydanticスキーマ追加
   - `/api/programs/timetable` エンドポイント実装（2段階取得対応）
   - マルチ編成判定ロジック
   - 予約情報のJOIN

2. **基盤コンポーネント**
   - TimeTableStore（2段階取得ロジック含む）
   - Navigation.vue のアイコンのみモード追加
   - ルーティング設定
   - TimeTableUtils.ts

3. **番組表グリッド**
   - TimeTableGrid.vue（全DOM事前生成 + CSS hidden方式）
   - TimeTableProgramCell.vue
   - TimeTableChannelHeader.vue
   - TimeTableTimeScale.vue（REGZA風色グラデーション）
   - TimeTableCurrentTimeLine.vue
   - 日付遷移フロートボタン

4. **操作・インタラクション**
   - スクロール・ドラッグ・ホイール操作
   - 番組セルのクリック/ホバー展開
   - ReservationDetailDrawer との連携
   - 予約追加ボタンの実装

5. **設定・UI調整**
   - TimeTableSettingsDialog.vue
   - クライアント設定の追加（同期対象）
   - HeaderBar/SPHeaderBar への統合

6. **スタイリング・レスポンシブ**
   - REGZA風デザインの適用
   - ジャンルハイライトカラー
   - スマホ/タブレット対応

7. **テスト・調整**
   - 各デバイスでの動作確認
   - パフォーマンスチューニング
   - Mirakurunバックエンド時の動作確認

---

## 重要な実装ファイル一覧

### サーバー側
- `server/app/routers/ProgramsRouter.py` - 新規API追加
- `server/app/schemas.py` - スキーマ追加
- `server/app/models/Program.py` - 参照（変更なし）
- `server/app/models/Channel.py` - 参照（変更なし）

### クライアント側
- `client/src/views/TimeTable.vue` - 新規作成
- `client/src/components/TimeTable/*.vue` - 新規作成（6ファイル）
- `client/src/stores/TimeTableStore.ts` - 新規作成
- `client/src/stores/SettingsStore.ts` - 設定項目追加
- `client/src/components/Navigation.vue` - アイコンのみモード追加
- `client/src/components/HeaderBar.vue` - 番組表コントロール追加
- `client/src/components/SPHeaderBar.vue` - 番組表コントロール追加
- `client/src/views/Settings/General.vue` - 番組表設定への動線追加
- `client/src/router/index.ts` - ルート追加
- `client/src/utils/TimeTableUtils.ts` - 新規作成

### 既存コンポーネントの拡張
- `client/src/components/Reservations/ReservationDetailDrawer.vue` - **番組詳細表示対応 + 予約追加ボタンを追加実装**
  - 現在は予約の編集・削除のみ対応
  - **番組表からの利用**: 予約の有無に関わらず番組情報の詳細表示として機能するよう拡張
  - 番組表からの新規予約追加に対応するため、予約追加APIの呼び出しを実装
  - Mirakurunバックエンド時はグレーアウト＆notice表示
  - **チューナー不足時の警告/エラー表示**:
    - 一部のみ録画（Partial）: 黄色背景の警告バナーで「チューナー不足のため一部のみ録画されます」を表示
    - 録画不可（Unavailable）: 赤色背景のエラーバナーで「チューナー不足のため録画できません」を表示
    - 予約一覧からドロワーを開いた場合も同様に表示される
  - **過去番組の場合**: 予約関連UI（予約追加ボタン、録画設定など）は完全に非表示

- `client/src/views/Settings/General.vue` - **番組表設定ダイアログへの動線追加**
  - ピン留めチャンネル設定ボタンの下に「番組表の表示設定」ボタンを追加
  - クリックで `TimeTableSettingsDialog` を開く

### 既存機能の活用（参照のみ）
- `client/src/utils/ProgramUtils.ts` - 囲み文字ハイライト（`decorateProgramInfo()`）
- `client/src/utils/Utils.ts` - 28時間表記変換（`apply28HourClock()`）
- `client/src/styles/mixin.scss` - レスポンシブmixin
- `client/src/stores/ChannelsStore.ts` - `channels_list_with_pinned` ゲッターを活用
- `client/src/stores/SettingsStore.ts` - 既存設定を参照
  - `pinned_channel_ids`: ピン留めチャンネルリスト
  - `use_28hour_clock`: 28時間表記（24〜27時表記）のオン/オフ
- `client/src/components/Settings/PinnedChannelSettings.vue` - ピン留め順序設定（参照のみ）
